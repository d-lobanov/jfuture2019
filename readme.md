# Что это
Этот репозиторий содержит решение двух задач для JFuture:    
```
Произвести расчеты для двух задач с использованием любого JVM-языка без СУБД.

Представьте себя разработчиком системы аналитики киноискусства, которому нужно собрать данные и произвести расчеты по следующим пунктам:

1. Отобразить динамику выхода фильмов 5 любых жанров в Китае и США за последние три года.
2. Составить топ-5 режиссеров с наиболее высоким рейтингом фильмов.
```

# Как это работает
Для решения задач я использовал данные от IMDb: https://www.imdb.com/interfaces/. Они содержат наиболее полную информацию по фильмам выпускаемым как в США, так и в Китае.

Приложение умеет работать напрямую как с https://datasets.imdbws.com/, так и считывая файлы локально. Подробнее в "Как запустить".

# Решение задачи  №1
Для решение это задачи используются два датасета:
- `title.akas.tsv.gz` содержит идентификатор киноленты `titleId` и регион гдя он был выпущен `region`
- `title.basics.tsv.gz` содержит идентификатор киноленты `titleId`, её тип `titleType` (на интресует только movie), год когда выпущен `startYear` и жанры `genres` 

Идея в том, чтобы найти все фильмы с определённым жанром и годом выпуска. Отфильтровать и сгрупировать результат по регионам, и посчитать общее количество на каждый год, регион и жанр.

Порядок решения:
1. Извлечь `titleId`, `startYear` и `genres` из `title.basics.tsv.gz`, только если `titleType` = movie и 2017 ≤ `startYear` ≤ 2019;
2. Извлечь `titleId` и `region` из `title.akas.tsv.gz`, только если `region` in (US, CH) и `titleId` есть в результатах шага №1;
3. Для каждого `titleId` из шага №2, достать соответсвующую запись из шага №1. Для каждого ключа `region`, `year`, `genre` из `generes`, посчитать количество записей, только если `genres` in (Action, Documentary, Drama, Fantasy, Horror);
4. Отсортировать результат шага #3 по региону, жанру и году;
5. Вывести результат.

# Решение задачи  №2
Для решение это задачи используются четыре датасета:
- `title.basics.tsv.gz` содержит идентификатор киноленты `titleId`, её тип `titleType` (на интресует только movie)
- `title.ratings.tsv.gz` содержит идентификатор киноленты `titleId`, средний рейтинг киноленты `averageRating` и количество голосовавших `numVotes`
- `title.crew.tsv.gz` содержит идентификатор киноленты `titleId`, ID имен режиссёров `directors`
- `name.basics.tsv.gz` содержит идентификатор имени `nameId`, имя `primaryName`

Идея в том, чтобы найти все фильмы, извлечь их рейтинг, извлечь их режиссёров и посчитать среднюю оценку фильма каждого из режиссёров. Найти имена топ 5 режиссёров по оценке фильма и вывести результат.

Чтобы получить более достоверные результаты, нужно ввести ограничение на количество фильмов снятых режиссером и количество проголосовавших за каждый фильм. Пускай в топ попадут только режиссёры снявшие минимум 5 фильмов и каждый из их фильмов должен иметь минимум 1000 оценок.

Порядок решения:
1. Извлечь `titleId` из `title.basics.tsv.gz`, только если `titleType` = movie;
2. Извлечь рейтинг `averageRating` для каждого `titleId`, только если `titleId` есть в результате шага №1 и `numVotes` > 1000;
3. Извлечь режиссёров для каждого `titleId` из `title.crew.tsv.gz`;
4. Для каждого режисера посчитать средний рейтинг фильма используя результаты шага №2 и шага №3, только если количество фильмов у режисера > 5;
5. Отсортировать результат шага #4 по рейтингу и взять 5 верхних записей;
6. Найти имя для каждого из пяти режисеров;
7. Вывести результат.

# Как запустить
Для запуска необходим maven и Java 11+. Полное решение тестировалось на AWS EC2 t2.micro (1GiB memory, 1 vCPU), полное выполнение занимает примерно 1 минуту на этой машине.

Приложение может читать данные как напрямую из https://datasets.imdbws.com/, так и локальные файлы.

### Из https://datasets.imdbws.com/
Для запуска на чтение из https://datasets.imdbws.com/ запустить (рекомендуемый способ):
```
mvn clean install
java -Dfile.encoding=UTF-8 -jar target/jfuture2019-1.0-SNAPSHOT.jar
```

### Локально
Для запуска на чтение локально нужно создать папку datasets в корне и скачать все нужные файлы из https://datasets.imdbws.com/, например:
```
mkdir -p datasets &
wget https://datasets.imdbws.com/name.basics.tsv.gz -P datasets & 
wget https://datasets.imdbws.com/title.akas.tsv.gz -P datasets &
wget https://datasets.imdbws.com/title.basics.tsv.gz -P datasets &
wget https://datasets.imdbws.com/title.crew.tsv.gz -P datasets &
wget https://datasets.imdbws.com/title.ratings.tsv.gz -P datasets &
```

Затем запустить
```
mvn clean install
java -Dfile.encoding=UTF-8 -jar target/jfuture2019-1.0-SNAPSHOT.jar --local
```
